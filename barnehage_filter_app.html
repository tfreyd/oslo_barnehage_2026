<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSP restricts all content sources to trusted origins only. -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://*.tile.openstreetmap.org https://unpkg.com data:; connect-src 'self' https://unpkg.com;" />
  <title>Oslo Barnehage Finder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      --bg-1: #0b1f2a;
      --bg-2: #0f3a46;
      --card: #ffffff;
      --text: #12202a;
      --muted: #5b6b76;
      --line: #dbe5ea;
      --accent: #0f766e;
      --accent-2: #f59e0b;
      --shadow: 0 12px 30px rgba(8, 33, 46, 0.18);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--text);
      font-family: "Source Sans 3", sans-serif;
      background:
        radial-gradient(90rem 40rem at 10% -10%, rgba(245,158,11,0.22), transparent 60%),
        radial-gradient(70rem 50rem at 100% 0%, rgba(22,163,74,0.18), transparent 60%),
        linear-gradient(140deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 18px;
    }

    .shell {
      max-width: 1500px;
      margin: 0 auto;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #ecf4f7;
      animation: reveal .5s ease;
    }

    @keyframes reveal {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(120deg, #0f3b49, #12685f);
      color: #f2f8f9;
    }

    .title-wrap h1 {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-weight: 700;
      font-size: clamp(20px, 3vw, 30px);
      letter-spacing: 0.2px;
    }

    .title-wrap p {
      margin: 4px 0 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lang-select {
      border: 1px solid rgba(255,255,255,0.35);
      color: #fff;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }

    .lang-select option { color: #111; }

    .source-link {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.35);
    }

    .source-link:hover {
      background: rgba(255,255,255,0.2);
    }

    .layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      min-height: calc(100vh - 130px);
    }

    .panel {
      background: #f6fbfd;
      border-right: 1px solid var(--line);
      padding: 16px;
      overflow: auto;
    }

    .controls {
      display: grid;
      gap: 12px;
    }

    .field label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 13px;
      color: #1f3b48;
    }

    .field input, .field select {
      width: 100%;
      border: 1px solid #cddde3;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      background: #fff;
    }

    .seg {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      background: #e4eef2;
      border-radius: 12px;
      padding: 4px;
    }

    .seg button {
      border: 0;
      border-radius: 9px;
      padding: 8px 6px;
      cursor: pointer;
      background: transparent;
      color: #234;
      font-weight: 600;
      font-size: 13px;
      transition: .2s ease;
    }

    .seg button.active {
      background: #fff;
      color: var(--accent);
      box-shadow: 0 3px 9px rgba(14,45,56,0.15);
    }

    .stats {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .stat {
      border: 1px solid #d7e6ec;
      background: white;
      border-radius: 12px;
      padding: 10px 12px;
    }

    .stat .k { font-size: 12px; color: var(--muted); }
    .stat .v { font-family: "Space Grotesk", sans-serif; font-size: 22px; font-weight: 700; color: #0f3b49; }

    .content {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .map-pane {
      height: clamp(240px, 46vh, 520px);
      min-height: 220px;
      max-height: 75vh;
      position: relative;
      border-bottom: 1px solid #d7e6ec;
    }

    #map { width: 100%; height: 100%; min-height: 220px; }

    .map-resizer {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 14px;
      cursor: ns-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, rgba(15, 59, 73, 0), rgba(15, 59, 73, 0.08));
      user-select: none;
      touch-action: none;
    }

    .map-resizer::before {
      content: "";
      width: 54px;
      height: 4px;
      border-radius: 999px;
      background: #8ca6b3;
    }

    .results {
      padding: 12px;
      overflow: auto;
      background: #eef5f8;
      border-top: 1px solid #d7e6ec;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
    }

    .card {
      background: white;
      border: 1px solid #dbe7ec;
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .card h3 {
      margin: 0;
      font-size: 16px;
      font-family: "Space Grotesk", sans-serif;
      line-height: 1.25;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-size: 12px;
      background: #f1f7fa;
      border: 1px solid #d8e6ed;
      padding: 4px 8px;
      border-radius: 999px;
      color: #284353;
    }

    .meta { font-size: 13px; color: #3a5565; }
    .link { color: #0f766e; text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }

    .empty {
      background: #fff;
      border: 1px dashed #b8ccd6;
      border-radius: 14px;
      padding: 16px;
      color: #4e6472;
    }

    @media (max-width: 1020px) {
      .layout { grid-template-columns: 1fr; }
      .panel { border-right: 0; border-bottom: 1px solid var(--line); }
      .map-pane { height: clamp(220px, 38vh, 420px); max-height: 68vh; }
      .result-grid { grid-template-columns: 1fr; }
      body { padding: 10px; }
      .shell { border-radius: 16px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="title-wrap">
        <h1 id="title"></h1>
        <p id="subtitle"></p>
      </div>
      <div class="top-actions">
        <a href="https://github.com/tfreyd/oslo_barnehage_2026" target="_blank" rel="noopener" class="source-link" aria-label="Source code">⚡</a>
        <select id="lang" class="lang-select" aria-label="Language">
          <option value="no">Norsk</option>
          <option value="en">English</option>
          <option value="fr">Français</option>
          <option value="es">Español</option>
          <option value="ar">العربية</option>
          <option value="ku">Kurdî</option>
          <option value="so">Soomaali</option>
          <option value="tr">Türkçe</option>
          <option value="pl">Polski</option>
          <option value="vi">Tiếng Việt</option>
          <option value="hi">हिन्दी</option>
          <option value="fa">فارسی</option>
        </select>
      </div>
    </header>

    <div class="layout">
      <aside class="panel">
        <div class="controls">
          <div class="field">
            <label id="lbl-search" for="search"></label>
            <input id="search" type="text" />
          </div>

          <div class="field">
            <label id="lbl-bydel" for="bydel"></label>
            <select id="bydel"><option value="ALL"></option></select>
          </div>

          <div class="field">
            <label id="lbl-mode"></label>
            <div class="seg" role="tablist" aria-label="mode">
              <button data-mode="both" class="active" type="button"></button>
              <button data-mode="liten" type="button"></button>
              <button data-mode="stor" type="button"></button>
            </div>
          </div>

          <div class="field">
            <label id="lbl-min" for="minSpots"></label>
            <input id="minSpots" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div class="k" id="k-match"></div><div class="v" id="v-match">0</div></div>
          <div class="stat"><div class="k" id="k-liten"></div><div class="v" id="v-liten">0</div></div>
          <div class="stat"><div class="k" id="k-stor"></div><div class="v" id="v-stor">0</div></div>
        </div>
      </aside>

      <main class="content">
        <section class="map-pane" id="mapPane">
          <div id="map"></div>
          <div class="map-resizer" id="mapResizer" aria-label="Resize map" title="Drag to resize map"></div>
        </section>
        <section class="results">
          <div id="results" class="result-grid"></div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="./barnehage_data.js"></script>
  <script src="./barnehage_app.js"></script>
  <script>
    const I18N = {
      no: {
        title: "Finn barnehageplass i Oslo (2026)",
        subtitle: "Filtrer på bydel og avdelingstype",
        search: "Søk barnehage",
        searchPh: "Skriv navn...",
        bydel: "Bydel",
        allBydel: "Alle bydeler",
        mode: "Avdeling",
        both: "Begge",
        liten: "Liten",
        stor: "Stor",
        min: "Minimum ledige plasser",
        match: "Treff",
        sumLiten: "Sum liten",
        sumStor: "Sum stor",
        open: "Åpne side",
        noResults: "Ingen resultater med nåværende filter.",
        address: "Adresse",
        bydelLbl: "Bydel",
      },
      en: {
        title: "Oslo Kindergarten Finder (2026)",
        subtitle: "Filter by district and section type",
        search: "Search kindergarten",
        searchPh: "Type name...",
        bydel: "District",
        allBydel: "All districts",
        mode: "Section",
        both: "Both",
        liten: "Under 3",
        stor: "Over 3",
        min: "Minimum available spots",
        match: "Matches",
        sumLiten: "Total under 3",
        sumStor: "Total over 3",
        open: "Open page",
        noResults: "No results for the current filters.",
        address: "Address",
        bydelLbl: "District",
      },
      fr: {
        title: "Recherche de crèches à Oslo (2026)",
        subtitle: "Filtrer par district et section",
        search: "Rechercher une crèche",
        searchPh: "Saisir un nom...",
        bydel: "District",
        allBydel: "Tous les districts",
        mode: "Section",
        both: "Les deux",
        liten: "Moins de 3 ans",
        stor: "Plus de 3 ans",
        min: "Places disponibles minimum",
        match: "Résultats",
        sumLiten: "Total moins de 3 ans",
        sumStor: "Total plus de 3 ans",
        open: "Ouvrir la page",
        noResults: "Aucun résultat avec ces filtres.",
        address: "Adresse",
        bydelLbl: "District",
      },
      es: {
        title: "Buscador de guarderías en Oslo (2026)",
        subtitle: "Filtra por distrito y tipo de sección",
        search: "Buscar guardería",
        searchPh: "Escribe un nombre...",
        bydel: "Distrito",
        allBydel: "Todos los distritos",
        mode: "Sección",
        both: "Ambas",
        liten: "Menores de 3",
        stor: "Mayores de 3",
        min: "Plazas mínimas disponibles",
        match: "Resultados",
        sumLiten: "Total menores de 3",
        sumStor: "Total mayores de 3",
        open: "Abrir página",
        noResults: "No hay resultados con estos filtros.",
        address: "Dirección",
        bydelLbl: "Distrito",
      },
      ar: {
        title: "البحث عن حضانة في أوسلو (2026)",
        subtitle: "تصفية حسب المنطقة ونوع القسم",
        search: "البحث عن حضانة",
        searchPh: "اكتب الاسم...",
        bydel: "المنطقة",
        allBydel: "جميع المناطق",
        mode: "القسم",
        both: "الكل",
        liten: "أقل من 3",
        stor: "أكثر من 3",
        min: "الحد الأدنى من الأماكن المتاحة",
        match: "نتائج",
        sumLiten: "المجموع أقل من 3",
        sumStor: "المجموع أكثر من 3",
        open: "فتح الصفحة",
        noResults: "لا توجد نتائج مع هذه الفلاتر.",
        address: "العنوان",
        bydelLbl: "المنطقة",
      },
      ku: {
        title: "Pêşkêşkirina zaroktan a Osloyê (2026)",
        subtitle: "Li gorî taxazê û awayê beşê biguhere",
        search: "Pêşkêşkirinê bigere",
        searchPh: "Navê binivîse...",
        bydel: "Tax",
        allBydel: "Hemû tax",
        mode: "Beş",
        both: "Herdu",
        liten: "Ji 3 kêmtir",
        stor: "Ji 3 zêdetir",
        min: "Rêjmana herî kêm a cihên vala",
        match: "Encam",
        sumLiten: "Kurşê ji 3",
        sumStor: "Kurşê zêde ji 3",
        open: "Rûpel veke",
        noResults: "Encamên vê filtirê tune.",
        address: "Navnîşan",
        bydelLbl: "Tax",
      },
      so: {
        title: "Raadinta dhismooyinka carruurta Oslo (2026)",
        subtitle: "Kala sooca degmada nooca qaybta",
        search: "Raadhi dhismo",
        searchPh: "Qor magaca...",
        bydeg: "Degmo",
        allBydela: "Dhamma degmooyinka",
        mode: "Qayb",
        both: "Labadaba",
        liten: "Ka yar 3",
        stor: "Ka weyn 3",
        mindhac: "ug yaraynta joojiyeyaasha",
        match: "Natiijo",
        sumLiten: "Wadarta ka yar 3",
        sumStor: "Wadarta ka weyn 3",
        open: "Fur bogga",
        noResults: "Natiijo maahan ee shaandheynta hadda.",
        address: "Ciwaanka",
        bydelLbl: "Degmo",
      },
      tr: {
        title: "Oslo Anaokulu Bulucu (2026)",
        subtitle: "İlçeye ve bölüm türüne göre filtrele",
        search: "Anaokulu ara",
        searchPh: "İsim yaz...",
        bydel: "İlçe",
        allBydel: "Tüm ilçeler",
        mode: "Bölüm",
        both: "Her ikisi",
        liten: "3 yaş altı",
        stor: "3 yaş üstü",
        min: "Minimum boş yer",
        match: "Sonuçlar",
        sumLiten: "Toplam 3 yaş altı",
        sumStor: "Toplam 3 yaş üstü",
        open: "Sayfayı aç",
        noResults: "Mevcut filtreler için sonuç yok.",
        address: "Adres",
        bydelLbl: "İlçe",
      },
      pl: {
        title: "Szukaj przedszkola w Oslo (2026)",
        subtitle: "Filtruj według dzielnicy i typu oddziału",
        search: "Szukaj przedszkola",
        searchPh: "Wpisz nazwę...",
        bydel: "Dzielnica",
        allBydel: "Wszystkie dzielnice",
        mode: "Oddział",
        both: "Oba",
        liten: "Poniżej 3 lat",
        stor: "Powyżej 3 lat",
        min: "Minimalna liczba miejsc",
        match: "Wyniki",
        sumLiten: "Suma poniżej 3 lat",
        sumStor: "Suma powyżej 3 lat",
        open: "Otwórz stronę",
        noResults: "Brak wyników dla bieżących filtrów.",
        address: "Adres",
        bydelLbl: "Dzielnica",
      },
      vi: {
        title: "Tìm trường mẫu giáo ở Oslo (2026)",
        subtitle: "Lọc theo quận và loại nhóm",
        search: "Tìm trường mẫu giáo",
        searchPh: "Nhập tên...",
        bydel: "Quận",
        allBydel: "Tất cả các quận",
        mode: "Nhóm",
        both: "Cả hai",
        liten: "Dưới 3 tuổi",
        stor: "Trên 3 tuổi",
        min: "Số chỗ tối thiểu",
        match: "Kết quả",
        sumLiten: " dướiTổng 3",
        sumStor: "Tổng trên 3",
        open: "Mở trang",
        noResults: "Không có kết quả cho bộ lọc hiện tại.",
        address: "Địa chỉ",
        bydelLbl: "Quận",
      },
      hi: {
        title: "ओस्लो में नर्सरी खोजें (2026)",
        subtitle: "जिले और खंड प्रकार के अनुसार फ़िल्टर करें",
        search: "नर्सरी खोजें",
        searchPh: "नाम लिखें...",
        bydel: "जिला",
        allBydel: "सभी जिले",
        mode: "खंड",
        both: "दोनों",
        liten: "3 से कम",
        stor: "3 से अधिक",
        min: "न्यूनतम उपलब्ध स्थान",
        match: "परिणाम",
        sumLiten: "कुल 3 से कम",
        sumStor: "कुल 3 से अधिक",
        open: "पृष्ठ खोलें",
        noResults: "वर्तमान फ़िल्टर के लिए कोई परिणाम नहीं।",
        address: "पता",
        bydelLbl: "जिला",
      },
      fa: {
        title: "یافتن مهدکودک در اسلو (2026)",
        subtitle: "فیلتر بر اساس منطقه و نوع بخش",
        search: "جستجوی مهدکودک",
        searchPh: "نام را بنویسید...",
        bydel: "منطقه",
        allBydel: "همه مناطق",
        mode: "بخش",
        both: "هر دو",
        liten: "زیر 3 سال",
        stor: "بالای 3 سال",
        min: "حداقل فضای موجود",
        match: "نتایج",
        sumLiten: "مجموع زیر 3",
        sumStor: "مجموع بالای 3",
        open: "باز کردن صفحه",
        noResults: "هیچ نتیجه‌ای برای فیلترهای فعلی وجود ندارد.",
        address: "آدرس",
        bydelLbl: "منطقه",
      }
    };

    const bydelColors = {
      "Alna": "#1f77b4", "Bjerke": "#ff7f0e", "Frogner": "#2ca02c", "Gamle Oslo": "#d62728",
      "Grorud": "#9467bd", "Grünerløkka": "#8c564b", "Nordre Aker": "#e377c2", "Nordstrand": "#7f7f7f",
      "Østensjø": "#bcbd22", "Sagene": "#17becf", "Søndre Nordstrand": "#1b9e77", "St. Hanshaugen": "#d95f02",
      "Stovner": "#7570b3", "Ullern": "#e7298a", "Vestre Aker": "#66a61e"
    };

    let map = null;
    let markerLayer = null;
    const mapHost = document.getElementById("map");
    const mapPane = document.getElementById("mapPane");
    const mapResizer = document.getElementById("mapResizer");
    if (window.L && mapHost) {
      map = L.map("map").setView([59.9139, 10.7522], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);
      markerLayer = L.layerGroup().addTo(map);
    } else if (mapHost) {
      mapHost.innerHTML = '<div class="empty" style="margin:12px;">Map unavailable in this environment. Results are still shown below.</div>';
    }

    const ui = {
      lang: document.getElementById("lang"),
      search: document.getElementById("search"),
      bydel: document.getElementById("bydel"),
      minSpots: document.getElementById("minSpots"),
      results: document.getElementById("results"),
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      lblSearch: document.getElementById("lbl-search"),
      lblBydel: document.getElementById("lbl-bydel"),
      lblMode: document.getElementById("lbl-mode"),
      lblMin: document.getElementById("lbl-min"),
      modeButtons: [...document.querySelectorAll(".seg button")],
      kMatch: document.getElementById("k-match"),
      kLiten: document.getElementById("k-liten"),
      kStor: document.getElementById("k-stor"),
      vMatch: document.getElementById("v-match"),
      vLiten: document.getElementById("v-liten"),
      vStor: document.getElementById("v-stor")
    };
    let allRows = [];
    let mode = "both";
    let currentMapBounds = null;

    function t(key) { return I18N[ui.lang.value][key] || key; }

    function parseCSV(text) {
      const rows = [];
      let cur = "";
      let line = [];
      let out = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i], next = text[i + 1];
        if (ch === '"') {
          if (inQuotes && next === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (ch === "," && !inQuotes) { line.push(cur); cur = ""; continue; }
        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          line.push(cur); cur = "";
          if (line.some(v => v !== "")) out.push(line);
          line = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || line.length) { line.push(cur); out.push(line); }

      const headers = out[0] || [];
      for (let i = 1; i < out.length; i++) {
        const obj = {};
        for (let j = 0; j < headers.length; j++) obj[headers[j]] = out[i][j] ?? "";
        rows.push(obj);
      }
      return rows;
    }

    function selectedSpots(row) {
      const liten = Number(row.spot_litenavdeling || 0);
      const stor = Number(row.spot_storavdeling || 0);
      if (mode === "liten") return liten;
      if (mode === "stor") return stor;
      return Math.max(liten, stor);
    }

    function setLanguage() {
      ui.title.textContent = t("title");
      ui.subtitle.textContent = t("subtitle");
      ui.lblSearch.textContent = t("search");
      ui.search.placeholder = t("searchPh");
      ui.lblBydel.textContent = t("bydel");
      ui.lblMode.textContent = t("mode");
      ui.lblMin.textContent = t("min");
      ui.kMatch.textContent = t("match");
      ui.kLiten.textContent = t("sumLiten");
      ui.kStor.textContent = t("sumStor");

      ui.modeButtons[0].textContent = t("both");
      ui.modeButtons[1].textContent = t("liten");
      ui.modeButtons[2].textContent = t("stor");

      const prev = ui.bydel.value;
      ui.bydel.options[0].textContent = t("allBydel");
      ui.bydel.value = prev;
    }

    function loadBydeler(rows) {
      const bydeler = [...new Set(rows.map(r => r.bydel).filter(Boolean))].sort((a,b) => a.localeCompare(b));
      for (const b of bydeler) {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        ui.bydel.appendChild(opt);
      }
    }

    function baseRows() {
      const q = ui.search.value.trim().toLowerCase();
      const b = ui.bydel.value;

      return allRows.filter(r => {
        if (b !== "ALL" && r.bydel !== b) return false;
        if (q && !(r.barnehage || "").toLowerCase().includes(q)) return false;
        return true;
      });
    }

    function filterRows() {
      const min = Math.max(0, Number(ui.minSpots.value || 0));
      const hasViewport = !!(currentMapBounds && window.L);

      return baseRows().filter(r => {
        if (selectedSpots(r) < min) return false;
        if (!hasViewport) return true;
        const lat = Number(r.latitude);
        const lon = Number(r.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
        return currentMapBounds.contains([lat, lon]);
      });
    }

    function renderStats(rows) {
      const sumL = rows.reduce((s, r) => s + Number(r.spot_litenavdeling || 0), 0);
      const sumS = rows.reduce((s, r) => s + Number(r.spot_storavdeling || 0), 0);
      ui.vMatch.textContent = String(rows.length);
      ui.vLiten.textContent = String(sumL);
      ui.vStor.textContent = String(sumS);
    }

    function renderMap(rows) {
      if (!markerLayer || !window.L) return;
      markerLayer.clearLayers();

      rows.forEach(r => {
        const lat = Number(r.latitude), lon = Number(r.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const radius = 5;
        const color = bydelColors[r.bydel] || "#334155";

        const popupLink = r.barnehage_url
          ? `<br><a class="link" href="${escapeHtml(r.barnehage_url)}" target="_blank" rel="noopener">${t("open")}</a>`
          : "";
        const popup = `<b>${escapeHtml(r.barnehage)}</b><br>${t("bydelLbl")}: ${escapeHtml(r.bydel)}<br>Liten: ${escapeHtml(r.spot_litenavdeling)}<br>Stor: ${escapeHtml(r.spot_storavdeling)}<br>${escapeHtml(r.address || "")}${popupLink}`;

        L.circleMarker([lat, lon], {
          radius, color, fillColor: color, fillOpacity: 0.8, weight: 1
        }).bindPopup(popup).addTo(markerLayer);
      });

      // Keep Oslo centered by default; no automatic fitBounds.
    }

    function escapeHtml(value) {
      const str = value == null ? "" : String(value);
      return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
    }

    function renderResults(rows) {
      if (!rows.length) {
        ui.results.innerHTML = `<div class="empty">${t("noResults")}</div>`;
        return;
      }

      ui.results.innerHTML = rows.slice(0, 700).map(r => {
        const link = r.barnehage_url ? `<a class="link" href="${r.barnehage_url}" target="_blank" rel="noopener">${t("open")}</a>` : "";
        return `
          <article class="card">
            <h3>${escapeHtml(r.barnehage)}</h3>
            <div class="chips">
              <span class="chip">${escapeHtml(r.bydel)}</span>
              <span class="chip">Liten: ${escapeHtml(r.spot_litenavdeling)}</span>
              <span class="chip">Stor: ${escapeHtml(r.spot_storavdeling)}</span>
            </div>
            <div class="meta">${t("address")}: ${escapeHtml(r.address || "-")}</div>
            <div>${link}</div>
          </article>
        `;
      }).join("");
    }

    function refresh() {
      const rows = filterRows();
      renderStats(rows);
      renderMap(rows);
      renderResults(rows);
    }

    function bind() {
      ui.search.addEventListener("input", refresh);
      ui.bydel.addEventListener("input", refresh);
      ui.minSpots.addEventListener("input", refresh);
      ui.lang.addEventListener("change", () => { setLanguage(); refresh(); });

      ui.modeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          mode = btn.dataset.mode;
          ui.modeButtons.forEach(b => b.classList.toggle("active", b === btn));
          refresh();
        });
      });

      if (mapPane && mapResizer) {
        let startY = 0;
        let startHeight = 0;
        let active = false;

        const onMove = (event) => {
          if (!active) return;
          const next = startHeight + (event.clientY - startY);
          const min = 220;
          const max = Math.max(min + 40, Math.floor(window.innerHeight * 0.78));
          const height = Math.max(min, Math.min(max, next));
          mapPane.style.height = `${height}px`;
          if (map && window.L) {
            map.invalidateSize();
            currentMapBounds = map.getBounds();
            refresh();
          }
        };

        const stop = () => {
          active = false;
          document.body.style.cursor = "";
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("pointerup", stop);
        };

        mapResizer.addEventListener("pointerdown", (event) => {
          active = true;
          startY = event.clientY;
          startHeight = mapPane.getBoundingClientRect().height;
          document.body.style.cursor = "ns-resize";
          window.addEventListener("pointermove", onMove);
          window.addEventListener("pointerup", stop);
          event.preventDefault();
        });
      }
    }

    async function loadRows() {
      if (Array.isArray(window.BARNEHAGE_ROWS) && window.BARNEHAGE_ROWS.length) {
        return window.BARNEHAGE_ROWS;
      }
      try {
        const res = await fetch("./barnehage_spots_2026.csv");
        if (res.ok) {
          return parseCSV(await res.text());
        }
      } catch {
        // Ignore fetch errors (e.g. file:// without server)
      }
      return [];
    }

    async function init() {
      setLanguage();
      bind();
      if (map && window.L) {
        currentMapBounds = map.getBounds();
        map.on("moveend zoomend", () => {
          currentMapBounds = map.getBounds();
          refresh();
        });
        window.addEventListener("resize", () => map.invalidateSize());
      }
      allRows = await loadRows();
      if (!Array.isArray(allRows) || !allRows.length) {
        throw new Error("No data source available (embedded/json/csv).");
      }
      loadBydeler(allRows);
      refresh();
    }

    init().catch((err) => {
      ui.results.innerHTML = `<div class="empty">Data loading error: ${String(err.message || err)}</div>`;
    });
  </script>
</body>
</html>
