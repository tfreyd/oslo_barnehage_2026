const I18N = {
  no: {
    title: "Finn barnehageplass i Oslo (2026)",
    subtitle: "Filtrer på bydel og avdelingstype",
    search: "Søk barnehage",
    searchPh: "Skriv navn...",
    bydel: "Bydel",
    allBydel: "Alle bydeler",
    mode: "Avdeling",
    both: "Begge",
    liten: "Liten",
    stor: "Stor",
    min: "Minimum ledige plasser",
    match: "Treff",
    sumLiten: "Sum liten",
    sumStor: "Sum stor",
    open: "Åpne side",
    noResults: "Ingen resultater med nåværende filter.",
    address: "Adresse",
    bydelLbl: "Bydel",
  },
  en: {
    title: "Oslo Kindergarten Finder (2026)",
    subtitle: "Filter by district and section type",
    search: "Search kindergarten",
    searchPh: "Type name...",
    bydel: "District",
    allBydel: "All districts",
    mode: "Section",
    both: "Both",
    liten: "Under 3",
    stor: "Over 3",
    min: "Minimum available spots",
    match: "Matches",
    sumLiten: "Total under 3",
    sumStor: "Total over 3",
    open: "Open page",
    noResults: "No results for the current filters.",
    address: "Address",
    bydelLbl: "District",
  },
  fr: {
    title: "Recherche de crèches à Oslo (2026)",
    subtitle: "Filtrer par district et section",
    search: "Rechercher une crèche",
    searchPh: "Saisir un nom...",
    bydel: "District",
    allBydel: "Tous les districts",
    mode: "Section",
    both: "Les deux",
    liten: "Moins de 3 ans",
    stor: "Plus de 3 ans",
    min: "Places disponibles minimum",
    match: "Résultats",
    sumLiten: "Total moins de 3 ans",
    sumStor: "Total plus de 3 ans",
    open: "Ouvrir la page",
    noResults: "Aucun résultat avec ces filtres.",
    address: "Adresse",
    bydelLbl: "District",
  },
  es: {
    title: "Buscador de guarderías en Oslo (2026)",
    subtitle: "Filtra por distrito y tipo de sección",
    search: "Buscar guardería",
    searchPh: "Escribe un nombre...",
    bydel: "Distrito",
    allBydel: "Todos los distritos",
    mode: "Sección",
    both: "Ambas",
    liten: "Menores de 3",
    stor: "Mayores de 3",
    min: "Plazas mínimas disponibles",
    match: "Resultados",
    sumLiten: "Total menores de 3",
    sumStor: "Total mayores de 3",
    open: "Abrir página",
    noResults: "No hay resultados con estos filtros.",
    address: "Dirección",
    bydelLbl: "Distrito",
  },
  ar: {
    title: "البحث عن حضانة في أوسلو (2026)",
    subtitle: "تصفية حسب المنطقة ونوع القسم",
    search: "البحث عن حضانة",
    searchPh: "اكتب الاسم...",
    bydel: "المنطقة",
    allBydel: "جميع المناطق",
    mode: "القسم",
    both: "الكل",
    liten: "أقل من 3",
    stor: "أكثر من 3",
    min: "الحد الأدنى من الأماكن المتاحة",
    match: "نتائج",
    sumLiten: "المجموع أقل من 3",
    sumStor: "المجموع أكثر من 3",
    open: "فتح الصفحة",
    noResults: "لا توجد نتائج مع هذه الفلاتر.",
    address: "العنوان",
    bydelLbl: "المنطقة",
  },
  ku: {
    title: "Pêşkêşkirina zaroktan a Osloyê (2026)",
    subtitle: "Li gorî taxazê û awayê beşê biguhere",
    search: "Pêşkêşkirinê bigere",
    searchPh: "Navê binivîse...",
    bydel: "Tax",
    allBydel: "Hemû tax",
    mode: "Beş",
    both: "Herdu",
    liten: "Ji 3 kêmtir",
    stor: "Ji 3 zêdetir",
    min: "Rêjmana herî kêm a cihên vala",
    match: "Encam",
    sumLiten: "Kurşê ji 3",
    sumStor: "Kurşê zêde ji 3",
    open: "Rûpel veke",
    noResults: "Encamên vê filtirê tune.",
    address: "Navnîşan",
    bydelLbl: "Tax",
  },
  so: {
    title: "Raadinta dhismooyinka carruurta Oslo (2026)",
    subtitle: "Kala sooca degmada nooca qaybta",
    search: "Raadhi dhismo",
    searchPh: "Qor magaca...",
    bydel: "Degmo",
    allBydel: "Dhamma degmooyinka",
    mode: "Qayb",
    both: "Labadaba",
    liten: "Ka yar 3",
    stor: "Ka weyn 3",
    min: "ug yaraynta joojiyeyaasha",
    match: "Natiijo",
    sumLiten: "Wadarta ka yar 3",
    sumStor: "Wadarta ka weyn 3",
    open: "Fur bogga",
    noResults: "Natiijo maahan ee shaandheynta hadda.",
    address: "Ciwaanka",
    bydelLbl: "Degmo",
  },
  tr: {
    title: "Oslo Anaokulu Bulucu (2026)",
    subtitle: "İlçeye ve bölüm türüne göre filtrele",
    search: "Anaokulu ara",
    searchPh: "İsim yaz...",
    bydel: "İlçe",
    allBydel: "Tüm ilçeler",
    mode: "Bölüm",
    both: "Her ikisi",
    liten: "3 yaş altı",
    stor: "3 yaş üstü",
    min: "Minimum boş yer",
    match: "Sonuçlar",
    sumLiten: "Toplam 3 yaş altı",
    sumStor: "Toplam 3 yaş üstü",
    open: "Sayfayı aç",
    noResults: "Mevcut filtreler için sonuç yok.",
    address: "Adres",
    bydelLbl: "İlçe",
  },
  pl: {
    title: "Szukaj przedszkola w Oslo (2026)",
    subtitle: "Filtruj według dzielnicy i typu oddziału",
    search: "Szukaj przedszkola",
    searchPh: "Wpisz nazwę...",
    bydel: "Dzielnica",
    allBydel: "Wszystkie dzielnice",
    mode: "Oddział",
    both: "Oba",
    liten: "Poniżej 3 lat",
    stor: "Powyżej 3 lat",
    min: "Minimalna liczba miejsc",
    match: "Wyniki",
    sumLiten: "Suma poniżej 3 lat",
    sumStor: "Suma powyżej 3 lat",
    open: "Otwórz stronę",
    noResults: "Brak wyników dla bieżących filtrów.",
    address: "Adres",
    bydelLbl: "Dzielnica",
  },
  vi: {
    title: "Tìm trường mẫu giáo ở Oslo (2026)",
    subtitle: "Lọc theo quận và loại nhóm",
    search: "Tìm trường mẫu giáo",
    searchPh: "Nhập tên...",
    bydel: "Quận",
    allBydel: "Tất cả các quận",
    mode: "Nhóm",
    both: "Cả hai",
    liten: "Dưới 3 tuổi",
    stor: "Trên 3 tuổi",
    min: "Số chỗ tối thiểu",
    match: "Kết quả",
    sumLiten: "Tổng dưới 3",
    sumStor: "Tổng trên 3",
    open: "Mở trang",
    noResults: "Không có kết quả cho bộ lọc hiện tại.",
    address: "Địa chỉ",
    bydelLbl: "Quận",
  },
  hi: {
    title: "ओस्लो में नर्सरी खोजें (2026)",
    subtitle: "जिले और खंड प्रकार के अनुसार फ़िल्टर करें",
    search: "नर्सरी खोजें",
    searchPh: "नाम लिखें...",
    bydel: "जिला",
    allBydel: "सभी जिले",
    mode: "खंड",
    both: "दोनों",
    liten: "3 से कम",
    stor: "3 से अधिक",
    min: "न्यूनतम उपलब्ध स्थान",
    match: "परिणाम",
    sumLiten: "कुल 3 से कम",
    sumStor: "कुल 3 से अधिक",
    open: "पृष्ठ खोलें",
    noResults: "वर्तमान फ़िल्टर के लिए कोई परिणाम नहीं।",
    address: "पता",
    bydelLbl: "जिला",
  },
  fa: {
    title: "یافتن مهدکودک در اسلو (2026)",
    subtitle: "فیلتر بر اساس منطقه و نوع بخش",
    search: "جستجوی مهدکودک",
    searchPh: "نام را بنویسید...",
    bydel: "منطقه",
    allBydel: "همه مناطق",
    mode: "بخش",
    both: "هر دو",
    liten: "زیر 3 سال",
    stor: "بالای 3 سال",
    min: "حداقل فضای موجود",
    match: "نتایج",
    sumLiten: "مجموع زیر 3",
    sumStor: "مجموع بالای 3",
    open: "باز کردن صفحه",
    noResults: "هیچ نتیجه‌ای برای فیلترهای فعلی وجود ندارد.",
    address: "آدرس",
    bydelLbl: "منطقه",
  }
};

const bydelColors = {
  "Alna": "#1f77b4", "Bjerke": "#ff7f0e", "Frogner": "#2ca02c", "Gamle Oslo": "#d62728",
  "Grorud": "#9467bd", "Grünerløkka": "#8c564b", "Nordre Aker": "#e377c2", "Nordstrand": "#7f7f7f",
  "Østensjø": "#bcbd22", "Sagene": "#17becf", "Søndre Nordstrand": "#1b9e77", "St. Hanshaugen": "#d95f02",
  "Stovner": "#7570b3", "Ullern": "#e7298a", "Vestre Aker": "#66a61e"
};

let map = null;
let markerLayer = null;
const mapHost = document.getElementById("map");
const mapPane = document.getElementById("mapPane");
const mapResizer = document.getElementById("mapResizer");
if (window.L && mapHost) {
  map = L.map("map").setView([59.9139, 10.7522], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
} else if (mapHost) {
  mapHost.innerHTML = '<div class="empty" style="margin:12px;">Map unavailable in this environment. Results are still shown below.</div>';
}

const ui = {
  lang: document.getElementById("lang"),
  search: document.getElementById("search"),
  bydel: document.getElementById("bydel"),
  minSpots: document.getElementById("minSpots"),
  results: document.getElementById("results"),
  title: document.getElementById("title"),
  subtitle: document.getElementById("subtitle"),
  lblSearch: document.getElementById("lbl-search"),
  lblBydel: document.getElementById("lbl-bydel"),
  lblMode: document.getElementById("lbl-mode"),
  lblMin: document.getElementById("lbl-min"),
  modeButtons: [...document.querySelectorAll(".seg button")],
  kMatch: document.getElementById("k-match"),
  kLiten: document.getElementById("k-liten"),
  kStor: document.getElementById("k-stor"),
  vMatch: document.getElementById("v-match"),
  vLiten: document.getElementById("v-liten"),
  vStor: document.getElementById("v-stor")
};
let allRows = [];
let mode = "both";
let currentMapBounds = null;

function t(key) { return I18N[ui.lang.value][key] || key; }

function parseCSV(text) {
  const rows = [];
  let cur = "";
  let line = [];
  let out = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i], next = text[i + 1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) { line.push(cur); cur = ""; continue; }
    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (ch === "\r" && next === "\n") i++;
      line.push(cur); cur = "";
      if (line.some(v => v !== "")) out.push(line);
      line = [];
      continue;
    }
    cur += ch;
  }
  if (cur.length || line.length) { line.push(cur); out.push(line); }

  const headers = out[0] || [];
  for (let i = 1; i < out.length; i++) {
    const obj = {};
    for (let j = 0; j < headers.length; j++) obj[headers[j]] = out[i][j] ?? "";
    rows.push(obj);
  }
  return rows;
}

function selectedSpots(row) {
  const liten = Number(row.spot_litenavdeling || 0);
  const stor = Number(row.spot_storavdeling || 0);
  if (mode === "liten") return liten;
  if (mode === "stor") return stor;
  return Math.max(liten, stor);
}

function setLanguage() {
  ui.title.textContent = t("title");
  ui.subtitle.textContent = t("subtitle");
  ui.lblSearch.textContent = t("search");
  ui.search.placeholder = t("searchPh");
  ui.lblBydel.textContent = t("bydel");
  ui.lblMode.textContent = t("mode");
  ui.lblMin.textContent = t("min");
  ui.kMatch.textContent = t("match");
  ui.kLiten.textContent = t("sumLiten");
  ui.kStor.textContent = t("sumStor");

  ui.modeButtons[0].textContent = t("both");
  ui.modeButtons[1].textContent = t("liten");
  ui.modeButtons[2].textContent = t("stor");

  const prev = ui.bydel.value;
  ui.bydel.options[0].textContent = t("allBydel");
  ui.bydel.value = prev;
}

function loadBydeler(rows) {
  const bydeler = [...new Set(rows.map(r => r.bydel).filter(Boolean))].sort((a,b) => a.localeCompare(b));
  for (const b of bydeler) {
    const opt = document.createElement("option");
    opt.value = b;
    opt.textContent = b;
    ui.bydel.appendChild(opt);
  }
}

function baseRows() {
  const q = ui.search.value.trim().toLowerCase();
  const b = ui.bydel.value;

  return allRows.filter(r => {
    if (b !== "ALL" && r.bydel !== b) return false;
    if (q && !(r.barnehage || "").toLowerCase().includes(q)) return false;
    return true;
  });
}

function filterRows() {
  const min = Math.max(0, Number(ui.minSpots.value || 0));
  const hasViewport = !!(currentMapBounds && window.L);

  return baseRows().filter(r => {
    if (selectedSpots(r) < min) return false;
    if (!hasViewport) return true;
    const lat = Number(r.latitude);
    const lon = Number(r.longitude);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
    return currentMapBounds.contains([lat, lon]);
  });
}

function renderStats(rows) {
  const sumL = rows.reduce((s, r) => s + Number(r.spot_litenavdeling || 0), 0);
  const sumS = rows.reduce((s, r) => s + Number(r.spot_storavdeling || 0), 0);
  ui.vMatch.textContent = String(rows.length);
  ui.vLiten.textContent = String(sumL);
  ui.vStor.textContent = String(sumS);
}

function escapeHtml(value) {
  const str = value == null ? "" : String(value);
  return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
}

function isSafeUrl(url) {
  // Verify url is a string type before validation
  if (!url || typeof url !== 'string') return false;
  return /^https?:\/\//i.test(url);
}

function buildPopupHtml(r) {
  const parts = [
    `<b>${escapeHtml(r.barnehage)}</b>`,
    `${t("bydelLbl")}: ${escapeHtml(r.bydel)}`,
    `${t("liten")}: ${escapeHtml(String(r.spot_litenavdeling))}`,
    `${t("stor")}: ${escapeHtml(String(r.spot_storavdeling))}`,
    escapeHtml(r.address || "")
  ];
  return parts.join("<br>");
}

function buildLinkHtml(row) {
  const osloUrl = row.barnehage_url;
  const faktaUrl = getBarnehagefaktaUrl(row);
  
  let html = "";
  if (osloUrl && isSafeUrl(osloUrl)) {
    html += `<a class="btn" href="${escapeHtml(osloUrl)}" target="_blank" rel="noopener">Oslo kommune</a> `;
  }
  if (faktaUrl) {
    html += `<a class="btn" href="${escapeHtml(faktaUrl)}" target="_blank" rel="noopener">Barnehagefakta</a>`;
  }
  return html;
}

function renderMap(rows) {
  if (!markerLayer || !window.L) return;
  markerLayer.clearLayers();

  rows.forEach(r => {
    const lat = Number(r.latitude), lon = Number(r.longitude);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
    const radius = 5;
    const color = bydelColors[r.bydel] || "#334155";

    const popup = buildPopupHtml(r);

    L.circleMarker([lat, lon], {
      radius, color, fillColor: color, fillOpacity: 0.8, weight: 1
    }).bindPopup(popup).addTo(markerLayer);
  });

  // Keep Oslo centered by default; no automatic fitBounds.
}

function renderResults(rows) {
  if (!rows.length) {
    ui.results.innerHTML = `<div class="empty">${t("noResults")}</div>`;
    return;
  }

  ui.results.innerHTML = rows.slice(0, 700).map(r => {
    const link = buildLinkHtml(r);
    return `
      <article class="card">
        <h3>${escapeHtml(r.barnehage)}</h3>
        <div class="chips">
          <span class="chip">${escapeHtml(r.bydel)}</span>
          <span class="chip">${t("liten")}: ${escapeHtml(String(r.spot_litenavdeling))}</span>
          <span class="chip">${t("stor")}: ${escapeHtml(String(r.spot_storavdeling))}</span>
        </div>
        <div class="meta">${t("address")}: ${escapeHtml(r.address || "-")}</div>
        <div>${link}</div>
      </article>
    `;
  }).join("");
}

function refresh() {
  const rows = filterRows();
  renderStats(rows);
  renderMap(rows);
  renderResults(rows);
}

function bind() {
  ui.search.addEventListener("input", refresh);
  ui.bydel.addEventListener("input", refresh);
  ui.minSpots.addEventListener("input", refresh);
  ui.lang.addEventListener("change", () => { setLanguage(); refresh(); });

  ui.modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      mode = btn.dataset.mode;
      ui.modeButtons.forEach(b => b.classList.toggle("active", b === btn));
      refresh();
    });
  });

  if (mapPane && mapResizer) {
    let startY = 0;
    let startHeight = 0;
    let active = false;

    const onMove = (event) => {
      if (!active) return;
      const next = startHeight + (event.clientY - startY);
      const min = 220;
      const max = Math.max(min + 40, Math.floor(window.innerHeight * 0.78));
      const height = Math.max(min, Math.min(max, next));
      mapPane.style.height = `${height}px`;
      if (map && window.L) {
        map.invalidateSize();
        currentMapBounds = map.getBounds();
        refresh();
      }
    };

    const stop = () => {
      active = false;
      document.body.style.cursor = "";
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", stop);
    };

    mapResizer.addEventListener("pointerdown", (event) => {
      active = true;
      startY = event.clientY;
      startHeight = mapPane.getBoundingClientRect().height;
      document.body.style.cursor = "ns-resize";
      window.addEventListener("pointermove", onMove);
      window.addEventListener("pointerup", stop);
      event.preventDefault();
    });
  }
}

async function loadRows() {
  if (Array.isArray(window.BARNEHAGE_ROWS) && window.BARNEHAGE_ROWS.length) {
    return window.BARNEHAGE_ROWS;
  }
  try {
    const res = await fetch("./barnehage_spots_2026.csv");
    if (res.ok) {
      return parseCSV(await res.text());
    }
  } catch {
    // Ignore fetch errors (e.g. file:// without server)
  }
  return [];
}

// Map of "lat,lon" -> orgnr for barnehagefakta lookup
let barnehagefaktaList = [];

async function loadBarnehagefaktaMap() {
  try {
    // Fetch all barnehagers in Oslo area
    const res = await fetch("https://barnehagefakta.no/api/Location/radius?lat=59.9139&lon=10.7522&radius=50000");
    if (res.ok) {
      const data = await res.json();
      // Filter to Oslo only (kommunenummer 0301)
      barnehagefaktaList = data.filter(b => b.koordinatLatLng && b.orgnr && b.kommunenummer === "0301");
      console.log(`Loaded ${barnehagefaktaList.length} Oslo barnehagefakta entries`);
    }
  } catch (e) {
    console.warn("Could not load barnehagefakta map:", e);
  }
}

function getBarnehagefaktaUrl(row) {
  if (!row.latitude || !row.longitude) return null;
  const lat = Number(row.latitude);
  const lon = Number(row.longitude);
  
  // Find closest match within ~100 meters
  let closest = null;
  let minDist = Infinity;
  for (const b of barnehagefaktaList) {
    const [blat, blon] = b.koordinatLatLng;
    const dist = Math.sqrt(Math.pow(lat - blat, 2) + Math.pow(lon - blon, 2));
    // ~100m threshold (0.001 degrees ≈ 100m)
    if (dist < 0.001 && dist < minDist) {
      minDist = dist;
      closest = b;
    }
  }
  
  if (closest) {
    const slug = (closest.navn || "").toLowerCase().replace(/[æøå]/g, e => ({"æ": "a", "ø": "o", "å": "a"}[e])).replace(/[^\w\s-]/g, "").replace(/\s+/g, "-").replace(/-+/g, "-").trim();
    return `https://barnehagefakta.no/barnehage/${closest.orgnr}/${slug}`;
  }
  return null;
}

async function init() {
  setLanguage();
  bind();
  if (map && window.L) {
    currentMapBounds = map.getBounds();
    map.on("moveend zoomend", () => {
      currentMapBounds = map.getBounds();
      refresh();
    });
    window.addEventListener("resize", () => map.invalidateSize());
  }
  // Load barnehagefakta mapping in parallel with CSV data
  const [rows] = await Promise.all([
    loadRows(),
    loadBarnehagefaktaMap()
  ]);
  allRows = rows;
  if (!Array.isArray(allRows) || !allRows.length) {
    throw new Error("No data source available (embedded/json/csv).");
  }
  loadBydeler(allRows);
  refresh();
}

init().catch((err) => {
  ui.results.innerHTML = `<div class="empty">Data loading error: ${String(err.message || err)}</div>`;
});

